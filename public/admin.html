<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ç®¡ç†è€…ç”»é¢</title>
<link rel="stylesheet" href="/style.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ===============================
   åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
=============================== */
.container{
  height:100vh;
}

/* ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°é¸æŠï¼ˆä¸­å¤®å¯„ã›ã‚«ãƒ¼ãƒ‰ï¼‰ */
#meetingSelect{
  max-width:600px;
  margin:60px auto;
}

/* ãƒ¡ã‚¤ãƒ³2ã‚«ãƒ©ãƒ UI */
#mainUI{
  display:grid;
  grid-template-columns: 2fr 3fr;
  gap:24px;
  padding:0 6px;
  height:100vh;
}

.left,
.right{
  overflow-y:auto;
}

.rightBottom{
  padding:16px;
  border-radius:8px;
  overflow-y:auto;
  background:#c9c9c9;
}
.poll-header{
  display:flex;
  align-items:center;
  gap:12px;
}

.poll-header h2{
  margin:24px 8px;   /* â† ä¸Šä¸‹ã®ä½™ç™½ã‚’å¿…è¦é‡ã ã‘æˆ»ã™ */
  line-height:1;
}

/* ===============================
   å…±é€šãƒ•ã‚©ãƒ¼ãƒ UI
=============================== */
input,
select,
textarea,
button{
  font-size:1rem;
}

input, select, textarea{
  padding:8px;
}

button{
  padding:8px 16px;
  white-space:nowrap;
  cursor:pointer;
}

/* æ¨ªä¸¦ã³æ±ç”¨è¡Œ */
.row{
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:12px;
}

.row input{ flex:1; }

/* ä¸Šéƒ¨ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èƒŒæ™¯è¨­å®šè¡Œ */
.topRow{
  display:flex;
  align-items:center;
  gap:16px;
  margin-bottom:16px;
}

.group{
  display:flex;
  align-items:center;
  gap:8px;
}

.group input{ width:200px; }

.spacer{ flex:1; }

/* ===============================
   è³ªå•ä½œæˆã‚¨ãƒªã‚¢
=============================== */
.createRow{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:flex-start;
}

#createRow input{ flex:2; min-width:200px; }
#createRow select{ flex:1; min-width:120px; }
#createRow textarea{
  flex:2;
  min-width:220px;
  height:80px;
  font-size:.95rem;
}
#createRow button{
  flex:0 0 auto;
  height:44px;
}

/* ===============================
   ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ãƒ–ãƒ­ãƒƒã‚¯
=============================== */
#meetingInfoCard input{
  width:100%;
  margin:6px 0 12px;
  font-size:.9rem;
}

.urlBlock{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:16px;
  text-align:center;
  margin-bottom:18px;
}

.urlBlock > div{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

/* ã‚¿ã‚¤ãƒˆãƒ«è¡Œ */
.urlBlock > div:nth-child(-n+3){
  font-weight:bold;
  margin-bottom:6px;
}

.urlBlock canvas{
  width:120px !important;
  height:120px !important;
}

.urlRow{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}

.urlRow input{
  flex:1;
  min-width:0;
  padding:6px 8px;
}

/* ===============================
   ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢
=============================== */
.previewWrap{
  display:flex;
  gap:24px;
  align-items:flex-start;
  margin-bottom:24px;
}

.previewLabel{
  color:#000;
  margin-bottom:8px;
  font-size:12px;
}

/* ã‚¹ãƒãƒ›ç¸¦é•· */
.phonePreview{ width:280px; }

.phonePreview iframe{
  width:100%;
  height:540px;
  border:8px solid #333;
  border-radius:24px;
  background:#000;
}

/* æŠ•å½±ç”»é¢ */
.screenPreview{ flex:1; }

.screenPreview iframe{
  width:100%;
  height:545px;
  border:4px solid #333;
  border-radius:12px;
  background:#000;
}

/* ===============================
   æŠ•ç¥¨çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å…±é€š
=============================== */
.preview{
  background:#000;
  color:#fff;
  border-radius:8px;
  padding:40px;
  margin-bottom:16px;
  transform:scale(.85);
  transform-origin:top left;
  font-size:28px;
  min-height:300px;
}

.preview #pv-area div{
  margin-bottom:12px;
}

/* ===============================
   ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å›ç­”ä¸€è¦§
=============================== */
#floatingAnswers{
  position:fixed;
  bottom:20px;
  right:20px;
  width:320px;
  max-height:60vh;
  background:#fff;
  border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.2);
  padding:16px;
  overflow-y:auto;
  z-index:9999;
}

#floatingAnswers h3{
  margin-top:0;
  font-size:1rem;
  border-bottom:1px solid #eee;
  padding-bottom:8px;
}

/* ===============================
   ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹
=============================== */
#pollSelect{
  width:70%;
}

@media (max-width: 900px){
  #mainUI{
    grid-template-columns: 1fr;
  }

  .previewWrap{
    flex-direction:column;
  }

  .phonePreview{
    width:100%;
  }

  .screenPreview iframe{
    height:400px;
  }
}
/* ===============================
   ã‚¿ãƒ–UI
=============================== */
.tabBar{
  display:flex;
  gap:8px;
  margin-bottom:16px;
}

.tabBtn{
  flex:1;
  padding:10px;
  border:none;
  background:#0095d9;;
  color:#fff;
  cursor:pointer;
  border-radius:6px 6px 0 0;
}

.tabBtn.active{
  background:#2563eb;;
  font-weight:bold;
}

.tabContent{
  display:none;
  animation: fade .15s ease-in-out;
}

.tabContent.active{
  display:block;
}

@keyframes fade{
  from{opacity:0; transform:translateY(4px)}
  to{opacity:1; transform:translateY(0)}
}
/* ===============================
   ç¾åœ¨ã®è³ªå•
=============================== */
.statusBtn{
  border-radius: 6px;
  padding: 1px 1px;
  width: 6em;
  height:1.5em;
  font-size: small;
}
/* ===============================
   æŠ•ç¥¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºè‰²
=============================== */
.statusBadge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-size:0.85rem;
  font-weight:bold;
  color:#fff;
  margin-right:8px;
}

/* æº–å‚™ä¸­ */
.status-editing{
  background:#6b7280; /* ã‚°ãƒ¬ãƒ¼ */
}

/* å›ç­”ä¸­ */
.status-voting{
  background:#16a34a; /* ã‚°ãƒªãƒ¼ãƒ³ */
}

/* åœæ­¢ä¸­ */
.status-stopping{
  background:#dc2626; /* ãƒ¬ãƒƒãƒ‰ */
}

/* ===============================
   ç”»é¢è¡¨ç¤ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²
=============================== */

/* éè¡¨ç¤º */
.screen-hidden{
  background:#6b7280; /* ã‚°ãƒ¬ãƒ¼ */
}

/* è¡¨ç¤ºä¸­ */
.screen-visible{
  background:#16a34a; /* ã‚°ãƒªãƒ¼ãƒ³ */
}
</style>
</head>
<body>

<div class="container">

  <div id="meetingSelect" class="card">
    <h2>ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†</h2>
    <input id="meetingName" placeholder="æ–°ã—ã„ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°å">
    <button onclick="createMeeting()">æ–°ã—ã„ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’é–‹ã</button>

    <h3>éå»ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h3>
    <div id="meetingList"></div>

    <input id="meetingIdInput" placeholder="ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ID">
    <button onclick="openMeetingById()">IDã§é–‹ã</button>
  </div>

  <div id="mainUI" style="display:none;">
    <div class="left">
      <h1>ç®¡ç†è€…UI</h1>
      <div class="topRow">
        <div class="group">
          <input id="meetingTitle" placeholder="ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¤ãƒˆãƒ«">
          <button onclick="changeTitle()">ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´</button>
        </div>
      </div>
          <strong id="meetingStatusLabel"></strong>
          <button id="toggleMeetingBtn" onclick="toggleMeeting()"></button>

  <h2>è³ªå•ä½œæˆ</h2>

  <div class="createRow">
    <input id="question" placeholder="è³ªå•">

    <select id="type" onchange="typechange()">
      <option value="choice">é¸æŠå¼</option>
      <option value="text">è‡ªç”±è¨˜è¼‰</option>
    </select>

    <div id="multiAnswer" style="display:none">
      <input type="checkbox" id="multiAnswerBox" name="multiAnswer" value="multiAnswer"/>
      <label>è¤‡æ•°å›ç­”</label>
    </div>
    <textarea id="options" placeholder="é¸æŠè‚¢ï¼ˆ1è¡Œ1ã¤ï¼‰"></textarea>

    <button onclick="createPoll()">ä½œæˆ</button>
  </div>

  <h2>è¨­å®š</h2>
        <label>èƒŒæ™¯è‰²</label><input type="color" id="bgColor" value="#000000" style="padding: 0;">
        <label>èƒŒæ™¯ç”»åƒ</label><input type="file" id="bgImage" accept="image/*">
        <button onclick="applyBackground()">é©ç”¨</button>

  <div class="card" id="meetingInfoCard">
    <h2>ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±</h2>
      <div><strong>Meeting IDï¼š</strong><span id="meetingIdDisplay"></span></div>

      <div class="urlBlock">
        <div>ğŸ›  ç®¡ç†ç”»é¢</div><div>ğŸ‘¥ å‚åŠ è€…ç”»é¢</div><div>ğŸ–¥ æŠ•å½±ç”»é¢</div>
        <div id="adminQR"></div><div id="participantQR"></div><div id="screenQR"></div>
      </div>
      <div>
        <div class="urlRow">ç®¡ç†ç”»é¢:<input id="adminUrl" readonly><button onclick="openPreview('adminUrl')">é–‹ã</button></div>
        <div class="urlRow">å‚åŠ è€…ç”»é¢:<input id="participantUrl" readonly><button onclick="openPreview('participantUrl')">é–‹ã</button></div>
        <div class="urlRow">æŠ•å½±ç”»é¢:<input id="screenUrl" readonly><button onclick="openPreview('screenUrl')">é–‹ã</button></div>
      </div>

    </div>
  </div>

    <div class="right">
      <div class="rightTop">
        <h2>ç¾åœ¨ã®è³ªå•</h2>
        <div class="card">
          <strong>å†…å®¹ï¼š</strong>
          <select id="pollSelect" onchange="switchPoll(this.value)">
            <option value="">è³ªå•ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
          <div id="current"></div>
        </div>
      </div>

      <div class="rightBottom">

        <!-- ã‚¿ãƒ–ãƒœã‚¿ãƒ³ -->
        <div class="tabBar">
          <button class="tabBtn active" onclick="switchTab('previewTab', this)">ç”»é¢</button>
          <button class="tabBtn" onclick="switchTab('clientsTab', this)">æ¥ç¶šè€…</button>
          <button class="tabBtn" onclick="switchTab('answersTab', this)">å›ç­”</button>
        </div>

        <!-- â–¼ ã‚¿ãƒ–ï¼šç”»é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div id="previewTab" class="tabContent active">
          <div class="previewWrap">
            <div class="phonePreview">
              <div class="previewLabel">å‚åŠ è€…ç”»é¢(é€ä¿¡ã—ã¦ã‚‚çµæœã«ã¯åæ˜ ã•ã‚Œã¾ã›ã‚“)</div>
              <iframe id="participantFrame"></iframe>
            </div>
            <div class="screenPreview">
              <div class="previewLabel">æŠ•å½±ç”»é¢</div>
              <iframe id="screenFrame"></iframe>
            </div>
          </div>
        </div>

        <!-- â–¼ ã‚¿ãƒ–ï¼šæ¥ç¶šè€…ä¸€è¦§ -->
        <div id="clientsTab" class="tabContent">
          <h3>ç¾åœ¨ã®æ¥ç¶šè€…</h3>
          <div id="clientList">æ¥ç¶šè€…æƒ…å ±ã‚’å–å¾—ä¸­...</div>
        </div>

        <!-- â–¼ ã‚¿ãƒ–ï¼šå›ç­”ä¸€è¦§ -->
        <div id="answersTab" class="tabContent">
          <h3 id="typeTitle">çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</h3>
          <div id="list"></div>
        </div>
      </div>


    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  const params = new URLSearchParams(location.search);
  let socket = io();  // â† å…ˆã«æ¥ç¶šã ã‘ä½œã‚‹ï¼ˆmeetingæœªå‚åŠ ï¼‰
  let meetingId = params.get("m");   // ä¾‹: admin.html?m=abcd1234
  let currentMeeting = null;
  let currentPoll = null;
  let optionsData = [];
  let answersData = [];
  let previewLoaded = false;

  const pool_status_master = { editing:"æº–å‚™ä¸­", voting:"å›ç­”ä¸­", stopping:"åœæ­¢ä¸­" };
  const pool_status_btn_master = { editing:"å›ç­”é–‹å§‹", voting:"å›ç­”æº–å‚™", stopping:"å›ç­”æº–å‚™" };
  const meeting_status_master = { open:"ä¼šè­°ä¸­", close:"çµ‚äº†" };
  const type_master = { choice:"é¸æŠå¼", text:"è‡ªç”±è¨˜è¼‰" };
  const screen_master = { 0:"éè¡¨ç¤º", 1:"è¡¨ç¤º" };
  const type_title_master = { choice:"é¸æŠå¼(çµæœ)", text:"è‡ªç”±è¨˜è¼‰(æ‰¿èªåˆ¶)" };
  const multi_answer_master = {true:"è¤‡æ•°å›ç­”å¯",false:"å˜ä¸€å›ç­”" }
  
  const MAX_VISIBLE_ANSWERS = 50; // â† è¡¨ç¤ºä¸Šé™

  socket.on("meetingCreated", m => {
    startMeeting(m.id);
  });

  socket.on("invalidMeeting", () => {
    alert("ã“ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°IDã¯å­˜åœ¨ã—ã¾ã›ã‚“");
    location.reload();
  });

  if(meetingId){
    meetingIdInput.value = meetingId
    openMeetingById()
  }


  function connectToMeeting(id){
    meetingId = id;
    socket.disconnect(); // æ—¢å­˜æ¥ç¶šã‚’åˆ‡ã‚‹
    socket = io({ query: { role:"admin", meetingId } }); // å†æ¥ç¶š
    
    registerSocketEvents();
    meetingIdDisplay.textContent = meetingId;
    const origin = location.origin;
    const adminURL       = `${origin}/admin.html?m=${meetingId}`;
    const participantURL = `${origin}/index.html?m=${meetingId}`;
    const screenURL      = `${origin}/screen.html?m=${meetingId}`;

    adminUrl.value = adminURL;
    participantUrl.value = participantURL;
    screenUrl.value = screenURL;

    // ğŸ”¥ åˆå›ã ã‘iframeã‚’ã‚»ãƒƒãƒˆï¼ˆã“ã“ãŒé‡è¦ï¼‰
    if(!previewLoaded){
      participantFrame.src = participantURL + "&preview=1";
      screenFrame.src      = screenURL;
      previewLoaded = true;
    }

    // QRç”Ÿæˆï¼ˆã“ã‚Œã¯æ¯å›OKï¼‰
    adminQR.innerHTML = "";
    participantQR.innerHTML = "";
    screenQR.innerHTML = "";

    new QRCode(adminQR,       { text: adminURL, width:128, height:128 });
    new QRCode(participantQR, { text: participantURL, width:128, height:128 });
    new QRCode(screenQR,      { text: screenURL, width:128, height:128 });

  }

  function registerSocketEvents(){

    socket.on("connect", () => {
      console.log("ğŸŸ¢ socket connected", socket.id);
    });

    socket.on("meeting", meeting => {
      if(!meeting) return;
      currentMeeting = meeting

      meetingTitle.value = meeting.title;
      meetingStatusLabel.innerText = meeting_status_master[meeting.status]

      if(meeting.status==="open"){
        toggleMeetingBtn.innerHTML = "ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’çµ‚äº†ã™ã‚‹";
      }else if(meeting.status==="close"){
        toggleMeetingBtn.innerHTML = "ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å†é–‹ã™ã‚‹";
      }
      render()
      
    });

    socket.on("settings", rows=>{
      const bg = rows.find(r=>r.setting_item==="background");
    });

    socket.on("pollList", renderPollList);

    socket.on("poll", data => {
      if (!data || !data.poll) return;

      currentPoll = data.poll;
      optionsData = data.options || [];
      answersData = (data.answers || []).slice(-500);
      

      // â˜… select ã¨å¼·åˆ¶åŒæœŸ
      if (pollSelect.value !== currentPoll.id) {
        const exists = [...pollSelect.options].some(o => o.value === currentPoll.id);
        if (exists) {
          pollSelect.value = currentPoll.id;
        }
      }

      render();
    });


    socket.on("clients", clients => {
      const box = document.getElementById("clientList");
      if(!clients || clients.length === 0){
        box.innerHTML = "æ¥ç¶šè€…ã¯ã„ã¾ã›ã‚“";
        return;
      }

      box.innerHTML = clients.map(c =>
        `<div class="card" style="margin-bottom:8px">
          <strong>${c.name || "åŒ¿å"}</strong><br>
          <small>${c.role}</small>
        </div>`
      ).join("");
    });


    socket.on("disconnect", () => {
      console.log("ğŸ”´ socket disconnected");
    });

  }


  function createMeeting(){
    if(!meetingName.value.trim()) return;
    socket.emit("createMeeting", meetingName.value);
  }

  function openMeetingById(){
    if(!meetingIdInput.value.trim()) return;
    startMeeting(meetingIdInput.value.trim());
  }

  function redirectURL(meetingId){
    const origin = location.origin;
    const adminURL = `${origin}/admin.html?m=${meetingId}`;
    window.location.replace(adminURL)
  }

  function startMeeting(id){
    if(!meetingId) redirectURL(id)
    previewLoaded = false; // â† ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ‡æ›¿æ™‚ã ã‘å†èª­è¾¼è¨±å¯
    meetingSelect.style.display = "none";
    mainUI.style.display = "grid";
    connectToMeeting(meetingId);
  }


function renderPollList(list){
  pollSelect.innerHTML = `<option value="">è³ªå•ã‚’é¸æŠã—ã¦ãã ã•ã„</option>`;
  if(!list) return;

  list.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.question;
    pollSelect.appendChild(opt);
  });

  // â˜… ã™ã§ã«ç¾åœ¨pollãŒåˆ†ã‹ã£ã¦ã„ã‚‹å ´åˆã¯å†é¸æŠ
  if(currentPoll){
    const exists = list.some(p => p.id === currentPoll.id);
    if(exists){
      pollSelect.value = currentPoll.id;
    }
  }
}

  function switchPoll(id){
    socket.emit("switchPoll", id);
  }

  function createPoll(){
    socket.emit("createPoll", {
      question: question.value,
      type: type.value,
      options: options.value.split("\n").filter(v=>v),
      multiAnswer: multiAnswer.checked
    });
  }

  function pollStatus(s){ socket.emit("setPollStatus", s); }
  function visibleSc(){ socket.emit("toggleScreen"); }
  function closeMeeting(){ socket.emit("setMeetingStatus", "closed");}
  function toggleMeeting(){ socket.emit("toggleMeeting"); }
  function togglePollStatus(){ socket.emit("togglePollStatus"); }

  function applyBackground(){
    const color = document.getElementById("bgColor").value;
    const fileInput = document.getElementById("bgImage");

    // ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç”»åƒå„ªå…ˆ
    if(fileInput.files.length > 0){
      const reader = new FileReader();
      reader.onload = function(e){
        socket.emit("updateSetting",{
          item:"background",
          value:`url(${e.target.result}) center/cover no-repeat`
        });
      };
      reader.readAsDataURL(fileInput.files[0]);
    }else{
      socket.emit("updateSetting",{
        item:"background",
        value: color
      });
    }
  }

  function changeTitle(){
    if(!meetingTitle.value.trim()) return;
    socket.emit("updateTitle", {title:meetingTitle.value.trim(), id:meetingId});
  }


  function render(){
  current.innerHTML="";
  list.innerHTML="";
  if(!currentPoll || !currentMeeting) return;

  current.innerHTML=`
    ç¨®é¡ï¼š${type_master[currentPoll.type]}(${multi_answer_master[currentPoll.multiAnswer]})<br>

    çŠ¶æ…‹ï¼š
    <span class="statusBadge status-${currentPoll.status}">
      ${pool_status_master[currentPoll.status]}
    </span>

    <button id="togglePollStatusBtn" class="statusBtn" onclick="togglePollStatus()">
      ${pool_status_btn_master[currentPoll.status]}
    </button>
    <button id="stopPollStatusBtn" class="statusBtn" onclick="pollStatus('stopping')">
      å›ç­”çµ‚äº†
    </button><br>

    ç”»é¢è¡¨ç¤ºï¼š
    <span class="statusBadge ${currentPoll.visible ? 'screen-visible' : 'screen-hidden'}">
      ${screen_master[currentPoll.visible]}
    </span>

    <button class="statusBtn" onclick="visibleSc()">
      çµæœã‚’${screen_master[currentPoll.visible^1]}
    </button>
  `;

  // â˜… ç”Ÿæˆå¾Œã«å–å¾—ã™ã‚‹
  const toggleBtn = document.getElementById("togglePollStatusBtn");
  const stopBtn   = document.getElementById("stopPollStatusBtn");

  if(currentMeeting.status==="open"){
    toggleBtn.style.display = "inline";
    stopBtn.style.display = "inline";
  }else{
    toggleBtn.style.display = "none";
    stopBtn.style.display = "none";
  }

  typeTitle.textContent = type_title_master[currentPoll.type];
  renderResultsToAdmin();
}
  function renderResultsToAdmin(){
    list.innerHTML = "";
    const isAtBottom = list.scrollTop + list.clientHeight >= list.scrollHeight - 10;

    if(!currentPoll) return;

    /* è‡ªç”±è¨˜è¼‰ */
    if(currentPoll.type === "text"){

      // ğŸ”¥ æ–°ã—ã„é †ã«ä¸¦ã¹ã¦æœ€æ–°50ä»¶ã ã‘è¡¨ç¤º
      const recentAnswers = answersData.slice(-MAX_VISIBLE_ANSWERS).reverse();

      const fragment = document.createDocumentFragment();

      recentAnswers.forEach(a=>{
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginBottom = "8px";

        card.innerHTML = `
          <button data-id="${a.id}">
            ${a.visible ? "éè¡¨ç¤º" : "æ‰¿èª"}
          </button>
          <div style="opacity:${a.visible?1:.4};margin-top:6px">${escapeHtml(a.text)}</div>
        `;

        card.querySelector("button").onclick = () => {
          socket.emit('toggleAnswerVisible', a.id);
        };

        fragment.appendChild(card);
      });

      list.appendChild(fragment);
      if(isAtBottom){
      list.scrollTop = list.scrollHeight;
    }
    }
  }


  function openPreview(inputId){
    const url = document.getElementById(inputId).value;
    if(!url) return alert("URLãŒã¾ã ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“");
    window.open(url, "_blank");
  }


  function typechange(){
    options.style.display=(type.value==="choice")?"block":"none";
    multiAnswer.style.display=(type.value==="text")?"block":"none";
  }

  function switchTab(tabId, btn){
    document.querySelectorAll(".tabContent").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));

    document.getElementById(tabId).classList.add("active");
    btn.classList.add("active");
  }

  function escapeHtml(str){
  if(!str) return "";
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

</script>
</body>
</html>
