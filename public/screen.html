<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>æŠ•å½±ç”»é¢</title>
<link rel="stylesheet" href="/style.css">
<style>
:root{
  --primary:#0066cc;
  --bg:#f5f7fa;
}
.wrapper{ padding:60px 80px; }
#title{ font-size:42px; margin-bottom:10px; opacity:.9; }
#question{ font-size:56px; font-weight:bold; margin-bottom:30px; }
#status{ font-size:24px; margin-bottom:30px; opacity:.7; }
#area{ margin-top:30px; }

.barRow{ margin-bottom:22px; }
.barLabel{ font-size:28px; margin-bottom:6px; }
.barBg{ background:#333; border-radius:8px; overflow:hidden; height:36px; }
.barFill{ height:100%; background:linear-gradient(90deg,#4caf50,#81c784); width:0%; transition:width .6s ease; }
.barCount{ font-size:22px; margin-top:6px; opacity:.8; }
.card{
  background:#fff;
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}

@keyframes fadeUp{
  from{opacity:0; transform:translateY(20px);}
  to{opacity:1; transform:translateY(0);}
}
</style>
</head>
<body>

<div class="wrapper">
  <div id="title"></div>
  <div id="question">ã—ã°ã‚‰ããŠå¾…ã¡ä¸‹ã•ã„</div>
  <div id="status"></div>
  <div id="area"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* =========================
   meetingId ã‚’URLã‹ã‚‰å–å¾—
========================= */
const params = new URLSearchParams(location.search);
const meetingId = params.get("m");   // ä¾‹: screen.html?m=abcd1234

if(!meetingId){
  document.body.innerHTML = "<h1>meetingId ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</h1>";
  throw new Error("meetingId missing");
}

/* =========================
   Socketæ¥ç¶šï¼ˆé‡è¦ä¿®æ­£ï¼‰
========================= */
const socket = io({ query:{ role:"screen", meetingId } });

const titleEl = document.getElementById("title");
const questionEl = document.getElementById("question");
const statusEl = document.getElementById("status");
const area = document.getElementById("area");

const statusText = {
  editing:"",
  voting:"ğŸŸ¢ å›ç­”å—ä»˜ä¸­",
  stopping:"ğŸŸ¡ å›ç­”çµ‚äº†"
};

/* =========================
   ä¼šè­°ã‚¿ã‚¤ãƒˆãƒ«å—ä¿¡
========================= */
socket.on("meeting", meeting=>{
  titleEl.textContent = meeting.title || "";
});

/* =========================
   è¨­å®šå—ä¿¡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåä¿®æ­£ï¼‰
========================= */
socket.on("settings", rows=>{
  const settings = {};
  rows.forEach(r=> settings[r.setting_item] = r.setting);
  if(settings.background)
    applyBackground(settings.background);
});

/* =========================
   æŠ•ç¥¨è¡¨ç¤º
========================= */
socket.on("poll", ({ poll, options=[], answers=[] })=>{
  questionEl.textContent =
    (poll.status==="voting" || poll.status==="stopping")
      ? poll.question
      : "ã—ã°ã‚‰ããŠå¾…ã¡ä¸‹ã•ã„";

  statusEl.textContent = statusText[poll.status] || "";
  area.innerHTML = "";

  if(poll.visible === 1 && poll.status !== "pause"){
    /* ---------- é¸æŠå¼ ---------- */
    if(poll.type==="choice"){
      const total = options.reduce((sum,o)=>sum+o.votes,0) || 1;

      options.forEach(o=>{
        const percent = Math.round((o.votes/total)*100);

        const row = document.createElement("div");
        row.className = "barRow";
        row.innerHTML = `
          <div class="barLabel">${o.text}</div>
          <div class="barBg">
            <div class="barFill" style="width:${percent}%"></div>
          </div>
          <div class="barCount">${o.votes} ç¥¨ï¼ˆ${percent}%ï¼‰</div>
        `;
        area.appendChild(row);
      });
    }

    /* ---------- è‡ªç”±è¨˜è¼‰ ---------- */
    if(poll.type==="text"){
      answers
        .filter(a=>a.visible)
        .slice(-8)
        .forEach(a=>{
          const div = document.createElement("div");
          div.className = "card";
          div.textContent = a.text;
          area.appendChild(div);
        });
    }
  }
});



function applyBackground(value){
  if(!value) return;

  document.body.style.background = value;

  // ç”»åƒç³»ã ã£ãŸå ´åˆã®è£œåŠ©æŒ‡å®š
  document.body.style.backgroundSize = "cover";
  document.body.style.backgroundPosition = "center";
  document.body.style.backgroundRepeat = "no-repeat";
  document.body.style.backgroundAttachment = "fixed";
}

</script>

</body>
</html>
